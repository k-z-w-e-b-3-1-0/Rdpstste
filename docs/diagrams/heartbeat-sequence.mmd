sequenceDiagram
    actor User as リモートユーザー
    participant TSLogon as タスク スケジューラ<br/>(ログオン タスク)
    participant SaveScript as save_remote_endpoint<br/>(.ps1 / .bat)
    participant Metadata as %ProgramData%\\Rdpstste\\remote-session.json
    participant TSHeartbeat as タスク スケジューラ<br/>(定期ハートビート)
    participant Heartbeat as session_notify<br/>(.ps1 / .bat)
    participant Collector as ハートビート Collector

    User->>TSLogon: Windows へログオン
    TSLogon->>SaveScript: ログオン時タスクを起動
    SaveScript->>Metadata: 接続元ホスト/IP\nセッション情報を保存
    Note over SaveScript,Metadata: PowerShell が使用できない場合は\nバッチフォールバックで JSON を生成

    loop 5分毎
        TSHeartbeat->>Heartbeat: ハートビートタスクを起動
        Heartbeat->>Metadata: remote-session.json を読み込み
        alt 保存済みメタデータあり
            Heartbeat->>Collector: 保存済みの接続情報を付加して送信
        else ファイルなし/失敗
            Heartbeat->>Collector: ライブ検出 or 空値で送信
        end
        Collector-->>Heartbeat: ACK / 結果応答
    end
