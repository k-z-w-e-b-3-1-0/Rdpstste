sequenceDiagram
    participant User as 利用者
    participant Client as 監視対象端末
    participant LogonTask as ログオンイベント
    participant Notify as session_notify(.ps1/.bat)
    participant EndTask as ログオフ/切断イベント
    participant EndAgent as session_end_event(.ps1/.bat)
    participant Collector as イベント Collector
    participant Store as 状態ストア

    User->>Client: ログオン / リモート接続
    Client->>LogonTask: タスク トリガーを発火
    LogonTask->>Notify: `session_notify` スクリプトを実行
    Notify->>Collector: POST /api/sessions/auto-heartbeat
    Collector->>Store: セッションを作成 or 更新 (status=connected)
    Collector-->>Notify: 200 OK / 受領完了

    User->>Client: ログオフ / セッション切断
    Client->>EndTask: 切断イベントを検知
    EndTask->>EndAgent: `session_end_event` スクリプトを実行
    EndAgent->>Collector: POST /api/sessions/end
    Collector->>Store: status=disconnected / endedAt 記録
    Collector-->>EndAgent: 200 OK / 受領完了
