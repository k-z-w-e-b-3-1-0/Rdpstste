# セッション利用状況トラッキングのイベント一覧

リモートアクセス元 IP の記録が難しい場合でも、ログオンやリモートセッション確立・切断のイベントを送信するだけで利用状況を把握できるよう、イベント種別ごとに取得しておきたい情報項目と活用方法を整理しました。

## 収集イベントと推奨項目

| イベント | 目的 | 推奨情報項目 | 主な活用方法 |
| --- | --- | --- | --- |
| セッション通知 (`session_notify`)<br>ログオン / リモート接続トリガー | 接続開始を検知し、利用状況を記録する | * タイムスタンプ (通知送信時刻)<br>* セッション ID / リソース ID<br>* 利用者 ID (ユーザー名、アカウント ID 等)<br>* 接続チャネル種別 (RDP、Console 等)<br>* 接続元端末 / IP アドレス<br>* クライアント環境情報 (OS、バージョン、アプリ名など)<br>* 任意: 起動中の主要プロセス一覧 | * どのユーザーがどのリソースへ接続したかの監査ログ<br>* ログオン直後の設定自動化や通知トリガーに利用 |
| セッション終了 (`session_end_event`)<br>切断 / ログオフ トリガー | 利用終了を把握し、利用時間やリソース解放を管理する | * タイムスタンプ (終了検知時刻)<br>* セッション ID / リソース ID<br>* 利用者 ID<br>* セッション継続時間 (通知時刻との差分)<br>* 切断理由 (ユーザー操作、タイムアウト、障害 など)<br>* 任意: 終了直前の主要プロセスやリソース使用量 | * 利用状況レポートの作成<br>* 異常な長時間セッションの検出<br>* リソースの自動停止・スケールイン判断 |
| 管理者操作 (`PUT /api/sessions/{id}`) | イベントを送信できなかった場合の手動補正 | * 更新者 ID<br>* 更新理由 (コメント)<br>* 変更前後のステータス | * 監査証跡の補完<br>* 臨時メンテナンス時の強制切断 |

## イベント トリガー設計のポイント

1. **ログソースの選定**: Windows の「ログオン」タスクや RemoteDesktopServices のイベント (ID 1149 など) をトリガーに設定すると、セッションが確立した瞬間に `session_notify` を送れます。
2. **複数トリガーの統合**: ログオンとリモート接続を区別したい場合は、PowerShell スクリプトで `eventTrigger` を `logon` / `remote-session` のように分けて送信します。
3. **終了検知の確実化**: ログオフ (イベント ID 4634) やセッション切断 (イベント ID 40) など複数の終了イベントを監視し、重複送信時はサーバー側で最新時刻を採用する設計にすると取りこぼしを防げます。
4. **リトライ戦略**: ネットワーク断を想定し、イベント送信スクリプトには再試行やキューイング処理を入れておくと信頼性が向上します。

## ログの整理・可視化

- **ログ構造化**: JSON 形式などの構造化ログで記録すると、後続の検索・集計が容易になります。
- **相関 ID**: セッション ID やトランザクション ID を共通項目にすることで、接続開始と終了のログを紐付けて追跡できます。
- **ダッシュボード例**:
  - 現在接続中セッション数 (最新の `session_notify` から切断されていないもの)
  - 利用開始 / 終了のイベントタイムライン
  - 平均利用時間、最大利用時間
  - ユーザー別 / リソース別の利用回数・利用時間

これらの一覧を基に、アクセス元 IP を取得しなくても、ユーザーの利用状況やセッションの健全性を把握できるモニタリング体制を整備できます。

## PowerShell スクリプト呼び出し時のオプションについて

付属のバッチファイルでは、PowerShell 実行時に `-NoProfile` と `-ExecutionPolicy Bypass` を指定しています。それぞれの意味は以下のとおりです。

- `-NoProfile`
  - PowerShell の起動時にユーザー/システムのプロファイルスクリプト (`profile.ps1`) を読み込まず、クリーンな状態で実行します。
  - ログオンスクリプトなど自動処理で利用する場合、ユーザー固有の設定に左右されないようにする目的で利用します。
- `-ExecutionPolicy Bypass`
  - 一時的に実行ポリシーのチェックをスキップし、対象スクリプトをそのまま実行します。
  - 署名のない内部スクリプトを確実に実行したい場合などに指定します。ポリシーを恒久的に緩めるわけではなく、呼び出し中のみ一時的にバイパスします。

これらのオプションを付与することで、利用環境の違いによるエラーを抑え、意図したスクリプトを安定して実行できます。
