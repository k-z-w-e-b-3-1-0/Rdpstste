# セッション利用状況トラッキングのイベント一覧

リモートアクセス元 IP の記録が難しい場合でも、セッション利用状況を把握できるよう、イベント種別ごとに取得しておきたい情報項目と、その活用方法を整理しました。

## 収集イベントと推奨項目

| イベント | 目的 | 推奨情報項目 | 主な活用方法 |
| --- | --- | --- | --- |
| セッション接続時<br>(使用開始リクエスト) | 接続開始を検知し、利用状況を記録する | * タイムスタンプ (接続要求受信時刻)<br>* セッション ID / リソース ID<br>* 利用者 ID (ユーザー名、アカウント ID 等)<br>* クライアント環境情報 (OS、バージョン、アプリ名など)<br>* 認証結果や MFA 実施有無<br>* 接続チャネル種別 (VPN、RDP 等) | * どのユーザーがどのリソースへ接続したかの監査ログ
* ログイン直後の設定自動化や通知トリガーに利用 |
| セッション切断時<br>(使用終了リクエスト) | 利用終了を把握し、利用時間やリソース解放を管理する | * タイムスタンプ (切断要求受信時刻)<br>* セッション ID / リソース ID<br>* 利用者 ID<br>* セッション継続時間 (接続時刻との差分)<br>* 切断理由 (ユーザー操作、タイムアウト、障害 など)<br>* リソース利用量メトリクス (任意: CPU 時間、転送量 等) | * 利用状況レポートの作成<br>* 異常な長時間セッションの検出<br>* リソースの自動停止・スケールイン判断 |
| ハートビート<br>(リモートログイン後の定期実行) | セッションが継続中か、アイドル状態かを把握する | * タイムスタンプ (ハートビート受信時刻)<br>* セッション ID / リソース ID<br>* 利用者 ID<br>* 前回操作からの経過時間 (クライアント側で計測できる場合)<br>* クライアントのアイドル判定フラグ (キー/マウス操作なし等)<br>* 任意: 利用中アプリケーションの概要 | * セッションが生きているかの死活監視<br>* アイドル時間が一定値を超えた場合の自動切断や警告
* 実利用時間を集計し、ライセンス/コスト最適化に活用 |

## ハートビートの設計ポイント

1. **送信間隔**: 30 秒〜数分間隔で、ネットワーク負荷と検知速度のバランスを調整します。
2. **タイムアウト設定**: 連続して一定回数ハートビートを受け取れなかった場合にセッション切断と見なす閾値を定めます。
3. **アイドル判定**: クライアント側でユーザー操作の有無を計測できる場合、ハートビートに「最後の操作時刻」または「アイドル状態フラグ」を含めると、接続維持中でもアイドルかどうかを判定できます。
4. **メトリクス連携**: 取得したデータを監視基盤 (例: Prometheus、CloudWatch Logs) に送信すると、ダッシュボード可視化やアラート設定が容易になります。

## ログの整理・可視化

- **ログ構造化**: JSON 形式などの構造化ログで記録すると、後続の検索・集計が容易になります。
- **相関 ID**: セッション ID やトランザクション ID を共通項目にすることで、接続開始〜終了〜ハートビートのログを紐付けて追跡できます。
- **ダッシュボード例**:
  - 現在接続中セッション数 (最後のハートビートが有効なもの)
  - アイドル状態セッション数 (一定時間操作なしのもの)
 - 平均利用時間、最大利用時間
  - ユーザー別 / リソース別の利用回数・利用時間

これらの一覧を基に、アクセス元 IP を取得しなくても、ユーザーの利用状況やセッションの健全性を把握できるモニタリング体制を整備できます。

## PowerShell スクリプト呼び出し時のオプションについて

付属のバッチファイルでは、PowerShell 実行時に `-NoProfile` と `-ExecutionPolicy Bypass` を指定しています。それぞれの意味は以下のとおりです。

- `-NoProfile`
  - PowerShell の起動時にユーザー/システムのプロファイルスクリプト (`profile.ps1`) を読み込まず、クリーンな状態で実行します。
  - ログオンスクリプトなど自動処理で利用する場合、ユーザー固有の設定に左右されないようにする目的で利用します。
- `-ExecutionPolicy Bypass`
  - 一時的に実行ポリシーのチェックをスキップし、対象スクリプトをそのまま実行します。
  - 署名のない内部スクリプトを確実に実行したい場合などに指定します。ポリシーを恒久的に緩めるわけではなく、呼び出し中のみ一時的にバイパスします。

これらのオプションを付与することで、利用環境の違いによるエラーを抑え、意図したスクリプトを安定して実行できます。
